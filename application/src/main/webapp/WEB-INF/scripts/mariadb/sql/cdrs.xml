<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
  @author thomas.quintana@telestax.com (Thomas Quintana)
-->
<mapper namespace="org.restcomm.sbc.dao.CDRDao">
  <insert id="addCDR" parameterType="map">
    INSERT INTO cdr (uid, fromUser, toUser, fromIP, startTime, endTime, duration, status) VALUES (#{uid}, #{fromUser},
		#{toUser}, #{fromIP}, #{startTime}, #{endTime}, #{duration}, #{status});
  </insert>
  
  <select id="getCDR" parameterType="string" resultType="hashmap">
    SELECT * FROM cdr WHERE uid=#{uid};
  </select>
  
  

	<select id="getTotalCDRByUsingFilters" parameterType="org.restcomm.sbc.bo.CDRFilter" resultType="int">
		SELECT COUNT(*) FROM cdr WHERE fromUser=#{fromUser}

		<if test="recipient != null">
			AND recipient like #{recipient}
		</if>
		<if test="sender != null">
			AND sender like #{sender}
		</if>
		<if test="status != null">
			AND status like #{status}
		</if>
		<if test="parentCallSid != null">
			AND parent_call_sid like #{parentCallSid}
		</if>
		<!-- select * from "restcomm_call_detail_records" where "start_time" >= '2013-08-23' order by "start_time" ; -->
		<if test="startTime != null">
		    AND startTime &gt;= #{startTime}
		</if>
	</select>
  
	<select id="getCDRByUsingFilters" parameterType="org.restcomm.sbc.bo.CDRFilter" resultType="hashmap">
		SELECT * FROM cdr AS restcomm_call_detail_records WHERE true

		<if test="recipient != null">
			AND recipient like #{recipient}
		</if>
		<if test="sender != null">
			AND sender like #{sender}
		</if>
		<if test="status != null">
			AND status like #{status}
		</if>
		<if test="parentCallSid != null">
			AND parent_call_sid like #{parentCallSid}
		</if>
		<!-- select * from "restcomm_call_detail_records" where "start_time" >= '2013-08-23' order by "start_time" ; -->
		<if test="startTime != null">
		    AND startTime &gt;= #{startTime} order by startTime
		</if>
		
		LIMIT #{limit} OFFSET #{offset}
	</select>  
  
  
  <select id="getCDRs" parameterType="string" resultType="hashmap">
    SELECT * FROM cdr ;
  </select>
  
  <select id="getCDRsByRecipient" parameterType="string" resultType="hashmap">
    SELECT * FROM cdr WHERE toUser=#{toUser};
  </select>
  
  <select id="getCDRsBySender" parameterType="string" resultType="hashmap">
    SELECT * FROM cdr WHERE fromUser=#{fromUser};
  </select>
  
  <select id="getCDRsByStatus" parameterType="string" resultType="hashmap">
    SELECT * FROM cdr WHERE status=#{status};
  </select>
  
  <select id="getCDRsByStartTime" parameterType="date" resultType="hashmap">
    SELECT * FROM cdr WHERE startTimegt;=#{startTime} AND startTime&lt;DATE_ADD(#{startTime},INTERVAL 1 DAY);
  </select>
  
  
  <delete id="removeCDR" parameterType="string">
    DELETE FROM cdr WHERE uid=#{uid};
  </delete>
  
  <delete id="removeCDRs" parameterType="string">
    DELETE FROM cdr ;
  </delete>
  
  <update id="updateCDR" parameterType="map">
    UPDATE cdr SET status=#{status}, startTime=#{startTime}, endTime=#{endTime}, duration=#{duration} WHERE uid=#{uid};
  </update>
</mapper>
